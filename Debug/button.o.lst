   1              		.cpu arm7tdmi
   2              		.fpu softvfp
   3              		.eabi_attribute 20, 1
   4              		.eabi_attribute 21, 1
   5              		.eabi_attribute 23, 3
   6              		.eabi_attribute 24, 1
   7              		.eabi_attribute 25, 1
   8              		.eabi_attribute 26, 1
   9              		.eabi_attribute 30, 6
  10              		.eabi_attribute 18, 4
  11              		.file	"button.c"
  21              	.Ltext0:
  22              		.file 1 "../button.c"
 2227              		.align	2
 2229              	boton_confirmado:
 2230              	.LFB0:
   1:../button.c   **** /*********************************************************************************************
   2:../button.c   **** * Fichero:      button.c
   3:../button.c   **** * Autor:
   4:../button.c   **** * Descrip:      Manejo de interrupciones de botones físicos (EINT6-7)
   5:../button.c   **** * Version:      2.0
   6:../button.c   **** * Comentarios:  Este módulo SOLO maneja el hardware de los botones físicos.
   7:../button.c   **** *               La lógica de la máquina de estados está en maquina_estados.c
   8:../button.c   **** *               Flujo: ISR → Timer3 (antirrebotes) → boton_confirmado → Maquina_Procesar_Boto
   9:../button.c   **** *********************************************************************************************/
  10:../button.c   **** 
  11:../button.c   **** /*--- ficheros de cabecera ---*/
  12:../button.c   **** #include "button.h"
  13:../button.c   **** #include "maquina_estados.h"  /* Máquina de estados del juego */
  14:../button.c   **** #include "eventos.h"
  15:../button.c   **** #include "timer3.h"
  16:../button.c   **** #include "44blib.h"
  17:../button.c   **** #include "44b.h"
  18:../button.c   **** #include "def.h"
  19:../button.c   **** 
  20:../button.c   **** /*=====================================================================================
  21:../button.c   ****  * CALLBACK PARA BOTONES CONFIRMADOS (sin rebotes)
  22:../button.c   ****  *====================================================================================*/
  23:../button.c   **** 
  24:../button.c   **** /*********************************************************************************************
  25:../button.c   **** * name:		boton_confirmado
  26:../button.c   **** * func:		Callback invocado por timer3 cuando un botón está confirmado (sin rebotes)
  27:../button.c   **** * para:		boton_id - ID del botón (EVENTO_BOTON_IZQUIERDO o EVENTO_BOTON_DERECHO)
  28:../button.c   **** * ret:		none
  29:../button.c   **** * comment:	Esta función solo delega el procesamiento a la máquina de estados.
  30:../button.c   **** *			NO contiene lógica del juego, solo interfaz hardware→software.
  31:../button.c   **** *********************************************************************************************/
  32:../button.c   **** static void boton_confirmado(INT8U boton_id)
  33:../button.c   **** {
 2231              		.loc 1 33 0
 2232              		.cfi_startproc
 2233              		@ Function supports interworking.
 2234              		@ args = 0, pretend = 0, frame = 8
 2235              		@ frame_needed = 1, uses_anonymous_args = 0
 2236 0000 0DC0A0E1 		mov	ip, sp
 2237              	.LCFI0:
 2238              		.cfi_def_cfa_register 12
 2239 0004 00D82DE9 		stmfd	sp!, {fp, ip, lr, pc}
 2240 0008 04B04CE2 		sub	fp, ip, #4
 2241              		.cfi_offset 14, -8
 2242              		.cfi_offset 13, -12
 2243              		.cfi_offset 11, -16
 2244              	.LCFI1:
 2245              		.cfi_def_cfa 11, 4
 2246 000c 08D04DE2 		sub	sp, sp, #8
 2247 0010 0030A0E1 		mov	r3, r0
 2248 0014 0D304BE5 		strb	r3, [fp, #-13]
  34:../button.c   **** 	/* Delegar el procesamiento a la máquina de estados */
  35:../button.c   **** 	Maquina_Procesar_Boton(boton_id);
 2249              		.loc 1 35 0
 2250 0018 0D305BE5 		ldrb	r3, [fp, #-13]	@ zero_extendqisi2
 2251 001c 0300A0E1 		mov	r0, r3
 2252 0020 FEFFFFEB 		bl	Maquina_Procesar_Boton
  36:../button.c   **** }
 2253              		.loc 1 36 0
 2254 0024 0CD04BE2 		sub	sp, fp, #12
 2255 0028 00689DE8 		ldmfd	sp, {fp, sp, lr}
 2256 002c 1EFF2FE1 		bx	lr
 2257              		.cfi_endproc
 2258              	.LFE0:
 2260              		.align	2
 2261              		.global	Eint4567_ISR
 2263              	Eint4567_ISR:
 2264              	.LFB1:
  37:../button.c   **** 
  38:../button.c   **** 
  39:../button.c   **** /*=====================================================================================
  40:../button.c   ****  * RUTINA DE SERVICIO DE INTERRUPCIÓN (ISR)
  41:../button.c   ****  *====================================================================================*/
  42:../button.c   **** 
  43:../button.c   **** /* declaración de función que es rutina de servicio de interrupción
  44:../button.c   ****  * https://gcc.gnu.org/onlinedocs/gcc/ARM-Function-Attributes.html */
  45:../button.c   **** void Eint4567_ISR(void) __attribute__((interrupt("IRQ")));
  46:../button.c   **** 
  47:../button.c   **** /*********************************************************************************************
  48:../button.c   **** * name:		Eint4567_ISR
  49:../button.c   **** * func:		Rutina de servicio de interrupción para botones físicos EINT6-7
  50:../button.c   **** * ret:		none
  51:../button.c   **** * comment:	Identifica qué botón fue presionado e inicia el proceso de antirrebotes.
  52:../button.c   **** *			NO procesa la lógica del juego directamente, solo identifica el botón.
  53:../button.c   **** *********************************************************************************************/
  54:../button.c   **** void Eint4567_ISR(void)
  55:../button.c   **** {
 2265              		.loc 1 55 0
 2266              		.cfi_startproc
 2267              		@ Interrupt Service Routine.
 2268              		@ args = 0, pretend = 0, frame = 8
 2269              		@ frame_needed = 1, uses_anonymous_args = 0
 2270 0030 04C02DE5 		str	ip, [sp, #-4]!
 2271 0034 0DC0A0E1 		mov	ip, sp
 2272              	.LCFI2:
 2273              		.cfi_def_cfa_register 12
 2274 0038 0FD82DE9 		stmfd	sp!, {r0, r1, r2, r3, fp, ip, lr, pc}
 2275 003c 04B04CE2 		sub	fp, ip, #4
 2276              		.cfi_offset 14, -8
 2277              		.cfi_offset 13, -12
 2278              		.cfi_offset 11, -16
 2279              		.cfi_offset 3, -20
 2280              		.cfi_offset 2, -24
 2281              		.cfi_offset 1, -28
 2282              		.cfi_offset 0, -32
 2283              	.LCFI3:
 2284              		.cfi_def_cfa 11, 4
 2285 0040 08D04DE2 		sub	sp, sp, #8
  56:../button.c   **** 	/* Identificar la interrupción (hay dos pulsadores) */
  57:../button.c   **** 	unsigned int pending = rEXTINTPND & 0xF;
 2286              		.loc 1 57 0
 2287 0044 8C309FE5 		ldr	r3, .L6
 2288 0048 003093E5 		ldr	r3, [r3, #0]
 2289 004c 0F3003E2 		and	r3, r3, #15
 2290 0050 24300BE5 		str	r3, [fp, #-36]
  58:../button.c   **** 	INT8U boton_id = 0;
 2291              		.loc 1 58 0
 2292 0054 0030A0E3 		mov	r3, #0
 2293 0058 1D304BE5 		strb	r3, [fp, #-29]
  59:../button.c   **** 
  60:../button.c   **** 	if (pending & 0x4)
 2294              		.loc 1 60 0
 2295 005c 24301BE5 		ldr	r3, [fp, #-36]
 2296 0060 043003E2 		and	r3, r3, #4
 2297 0064 000053E3 		cmp	r3, #0
 2298 0068 0200000A 		beq	.L3
  61:../button.c   **** 	{
  62:../button.c   **** 		boton_id = EVENTO_BOTON_IZQUIERDO;
 2299              		.loc 1 62 0
 2300 006c 0430A0E3 		mov	r3, #4
 2301 0070 1D304BE5 		strb	r3, [fp, #-29]
 2302 0074 050000EA 		b	.L4
 2303              	.L3:
  63:../button.c   **** 	}
  64:../button.c   **** 	else if (pending & 0x8)
 2304              		.loc 1 64 0
 2305 0078 24301BE5 		ldr	r3, [fp, #-36]
 2306 007c 083003E2 		and	r3, r3, #8
 2307 0080 000053E3 		cmp	r3, #0
 2308 0084 0100000A 		beq	.L4
  65:../button.c   **** 	{
  66:../button.c   **** 		boton_id = EVENTO_BOTON_DERECHO;
 2309              		.loc 1 66 0
 2310 0088 0830A0E3 		mov	r3, #8
 2311 008c 1D304BE5 		strb	r3, [fp, #-29]
 2312              	.L4:
  67:../button.c   **** 	}
  68:../button.c   **** 
  69:../button.c   **** 	if (boton_id != 0U)
 2313              		.loc 1 69 0
 2314 0090 1D305BE5 		ldrb	r3, [fp, #-29]	@ zero_extendqisi2
 2315 0094 000053E3 		cmp	r3, #0
 2316 0098 0200000A 		beq	.L5
  70:../button.c   **** 	{
  71:../button.c   **** 		/* Iniciar la máquina de antirrebotes. Si está ocupada, no hacer nada */
  72:../button.c   **** 		timer3_start_antirrebote(boton_id);
 2317              		.loc 1 72 0
 2318 009c 1D305BE5 		ldrb	r3, [fp, #-29]	@ zero_extendqisi2
 2319 00a0 0300A0E1 		mov	r0, r3
 2320 00a4 FEFFFFEB 		bl	timer3_start_antirrebote
 2321              	.L5:
  73:../button.c   **** 	}
  74:../button.c   **** 
  75:../button.c   **** 	/* Finalizar ISR: limpiar banderas de interrupción */
  76:../button.c   **** 	rEXTINTPND = 0xf;              // borra los bits en EXTINTPND
 2322              		.loc 1 76 0
 2323 00a8 28309FE5 		ldr	r3, .L6
 2324 00ac 0F20A0E3 		mov	r2, #15
 2325 00b0 002083E5 		str	r2, [r3, #0]
  77:../button.c   **** 	rI_ISPC   |= BIT_EINT4567;     // borra el bit pendiente en INTPND
 2326              		.loc 1 77 0
 2327 00b4 20309FE5 		ldr	r3, .L6+4
 2328 00b8 1C209FE5 		ldr	r2, .L6+4
 2329 00bc 002092E5 		ldr	r2, [r2, #0]
 2330 00c0 022682E3 		orr	r2, r2, #2097152
 2331 00c4 002083E5 		str	r2, [r3, #0]
  78:../button.c   **** }
 2332              		.loc 1 78 0
 2333 00c8 1CD04BE2 		sub	sp, fp, #28
 2334 00cc 0F689DE8 		ldmfd	sp, {r0, r1, r2, r3, fp, sp, lr}
 2335 00d0 04C09DE4 		ldmfd	sp!, {ip}
 2336 00d4 04F05EE2 		subs	pc, lr, #4
 2337              	.L7:
 2338              		.align	2
 2339              	.L6:
 2340 00d8 5400D201 		.word	30539860
 2341 00dc 2400E001 		.word	31457316
 2342              		.cfi_endproc
 2343              	.LFE1:
 2345              		.align	2
 2346              		.global	Eint4567_init
 2348              	Eint4567_init:
 2349              	.LFB2:
  79:../button.c   **** 
  80:../button.c   **** 
  81:../button.c   **** /*=====================================================================================
  82:../button.c   ****  * INICIALIZACIÓN DEL HARDWARE
  83:../button.c   ****  *====================================================================================*/
  84:../button.c   **** 
  85:../button.c   **** /*********************************************************************************************
  86:../button.c   **** * name:		Eint4567_init
  87:../button.c   **** * func:		Inicializa el hardware de los botones físicos EINT6-7
  88:../button.c   **** * ret:		none
  89:../button.c   **** * comment:	Configura:
  90:../button.c   **** *			- Timer3 para antirrebotes
  91:../button.c   **** *			- Controlador de interrupciones
  92:../button.c   **** *			- Puerto G (pines físicos de los botones)
  93:../button.c   **** *********************************************************************************************/
  94:../button.c   **** void Eint4567_init(void)
  95:../button.c   **** {
 2350              		.loc 1 95 0
 2351              		.cfi_startproc
 2352              		@ Function supports interworking.
 2353              		@ args = 0, pretend = 0, frame = 0
 2354              		@ frame_needed = 1, uses_anonymous_args = 0
 2355 00e0 0DC0A0E1 		mov	ip, sp
 2356              	.LCFI4:
 2357              		.cfi_def_cfa_register 12
 2358 00e4 00D82DE9 		stmfd	sp!, {fp, ip, lr, pc}
 2359 00e8 04B04CE2 		sub	fp, ip, #4
 2360              		.cfi_offset 14, -8
 2361              		.cfi_offset 13, -12
 2362              		.cfi_offset 11, -16
 2363              	.LCFI5:
 2364              		.cfi_def_cfa 11, 4
  96:../button.c   **** 	/* Inicializar el temporizador dedicado a la eliminación de rebotes */
  97:../button.c   **** 	timer3_init(boton_confirmado);
 2365              		.loc 1 97 0
 2366 00ec AC009FE5 		ldr	r0, .L9
 2367 00f0 FEFFFFEB 		bl	timer3_init
  98:../button.c   **** 
  99:../button.c   **** 	/* Configuracion del controlador de interrupciones. Estos registros están definidos en 44b.h */
 100:../button.c   **** 	rI_ISPC    = 0x3ffffff;         // Borra INTPND escribiendo 1s en I_ISPC
 2368              		.loc 1 100 0
 2369 00f4 A8309FE5 		ldr	r3, .L9+4
 2370 00f8 3F23E0E3 		mvn	r2, #-67108864
 2371 00fc 002083E5 		str	r2, [r3, #0]
 101:../button.c   **** 	rEXTINTPND = 0xf;               // Borra EXTINTPND escribiendo 1s en el propio registro
 2372              		.loc 1 101 0
 2373 0100 A0309FE5 		ldr	r3, .L9+8
 2374 0104 0F20A0E3 		mov	r2, #15
 2375 0108 002083E5 		str	r2, [r3, #0]
 102:../button.c   **** 	rINTMOD    = 0x0;               // Configura las lineas como de tipo IRQ
 2376              		.loc 1 102 0
 2377 010c 98309FE5 		ldr	r3, .L9+12
 2378 0110 0020A0E3 		mov	r2, #0
 2379 0114 002083E5 		str	r2, [r3, #0]
 103:../button.c   **** 	rINTCON    = 0x1;               // Habilita int. vectorizadas y la linea IRQ (FIQ no)
 2380              		.loc 1 103 0
 2381 0118 1E36A0E3 		mov	r3, #31457280
 2382 011c 0120A0E3 		mov	r2, #1
 2383 0120 002083E5 		str	r2, [r3, #0]
 104:../button.c   **** 	rINTMSK    &= ~(BIT_EINT4567);  // habilitamos interrupcion linea eint4567 en vector de mascaras
 2384              		.loc 1 104 0
 2385 0124 84309FE5 		ldr	r3, .L9+16
 2386 0128 80209FE5 		ldr	r2, .L9+16
 2387 012c 002092E5 		ldr	r2, [r2, #0]
 2388 0130 0226C2E3 		bic	r2, r2, #2097152
 2389 0134 002083E5 		str	r2, [r3, #0]
 105:../button.c   **** 
 106:../button.c   **** 	/* Establece la rutina de servicio para Eint4567 */
 107:../button.c   **** 	pISR_EINT4567 = (int) Eint4567_ISR;
 2390              		.loc 1 107 0
 2391 0138 74309FE5 		ldr	r3, .L9+20
 2392 013c 74209FE5 		ldr	r2, .L9+24
 2393 0140 002083E5 		str	r2, [r3, #0]
 108:../button.c   **** 
 109:../button.c   **** 	/* Configuracion del puerto G */
 110:../button.c   **** 	rPCONG  = 0xffff;                       // Establece la funcion de los pines (EINT0-7)
 2394              		.loc 1 110 0
 2395 0144 70309FE5 		ldr	r3, .L9+28
 2396 0148 70209FE5 		ldr	r2, .L9+32
 2397 014c 002083E5 		str	r2, [r3, #0]
 111:../button.c   **** 	rPUPG   = 0x0;                  // Habilita el "pull up" del puerto
 2398              		.loc 1 111 0
 2399 0150 6C309FE5 		ldr	r3, .L9+36
 2400 0154 0020A0E3 		mov	r2, #0
 2401 0158 002083E5 		str	r2, [r3, #0]
 112:../button.c   **** 	rEXTINT = rEXTINT | 0x22222222;   // Configura las lineas de int. como de flanco de bajada
 2402              		.loc 1 112 0
 2403 015c 64209FE5 		ldr	r2, .L9+40
 2404 0160 60309FE5 		ldr	r3, .L9+40
 2405 0164 001093E5 		ldr	r1, [r3, #0]
 2406 0168 5C309FE5 		ldr	r3, .L9+44
 2407 016c 033081E1 		orr	r3, r1, r3
 2408 0170 003082E5 		str	r3, [r2, #0]
 113:../button.c   **** 
 114:../button.c   **** 	/* Por precaucion, se vuelven a borrar los bits de INTPND y EXTINTPND */
 115:../button.c   **** 	rEXTINTPND = 0xf;                               // borra los bits en EXTINTPND
 2409              		.loc 1 115 0
 2410 0174 2C309FE5 		ldr	r3, .L9+8
 2411 0178 0F20A0E3 		mov	r2, #15
 2412 017c 002083E5 		str	r2, [r3, #0]
 116:../button.c   **** 	rI_ISPC   |= BIT_EINT4567;              // borra el bit pendiente en INTPND
 2413              		.loc 1 116 0
 2414 0180 1C309FE5 		ldr	r3, .L9+4
 2415 0184 18209FE5 		ldr	r2, .L9+4
 2416 0188 002092E5 		ldr	r2, [r2, #0]
 2417 018c 022682E3 		orr	r2, r2, #2097152
 2418 0190 002083E5 		str	r2, [r3, #0]
 117:../button.c   **** }
 2419              		.loc 1 117 0
 2420 0194 0CD04BE2 		sub	sp, fp, #12
 2421 0198 00689DE8 		ldmfd	sp, {fp, sp, lr}
 2422 019c 1EFF2FE1 		bx	lr
 2423              	.L10:
 2424              		.align	2
 2425              	.L9:
 2426 01a0 00000000 		.word	boton_confirmado
 2427 01a4 2400E001 		.word	31457316
 2428 01a8 5400D201 		.word	30539860
 2429 01ac 0800E001 		.word	31457288
 2430 01b0 0C00E001 		.word	31457292
 2431 01b4 74FF7F0C 		.word	209715060
 2432 01b8 00000000 		.word	Eint4567_ISR
 2433 01bc 4000D201 		.word	30539840
 2434 01c0 FFFF0000 		.word	65535
 2435 01c4 4800D201 		.word	30539848
 2436 01c8 5000D201 		.word	30539856
 2437 01cc 22222222 		.word	572662306
 2438              		.cfi_endproc
 2439              	.LFE2:
 2441              	.Letext0:
DEFINED SYMBOLS
                            *ABS*:00000000 button.c
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2227   .text:00000000 $a
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2229   .text:00000000 boton_confirmado
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2263   .text:00000030 Eint4567_ISR
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2340   .text:000000d8 $d
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2345   .text:000000e0 $a
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2348   .text:000000e0 Eint4567_init
C:\Users\jaime\AppData\Local\Temp\cclwERgc.s:2426   .text:000001a0 $d
                     .debug_frame:00000010 $d

UNDEFINED SYMBOLS
Maquina_Procesar_Boton
timer3_start_antirrebote
timer3_init
